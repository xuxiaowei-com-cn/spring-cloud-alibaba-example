name: Spring Cloud Alibaba 2022.0.x

on:
  push:
    branches: [ main, xuxiaowei/* ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      MYSQL_DATABASE: nacos
      NACOS_BOOTSTRAP_DIR: nacos-bootstrap-3.x
      NACOS_DATABASE_HOST: 127.0.0.1
      NACOS_DATABASE_PORT: 3306
      NACOS_DATABASE: nacos
      NACOS_DATABASE_USERNAME: root
      NACOS_DATABASE_PASSWORD: root
      NACOS_CREATE_TOKEN: true
      MODULE_NAME: spring-cloud-2022.0.x
      GITHUB_TOKEN: ${{ github.token }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=30
          --health-start-period=30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start RocketMQ
        run: |
          echo 'Create a custom network'
          docker network create rocketmq
          
          echo 'Start create NameServer'
          docker run -d --name rmqnamesrv -p 9876:9876 --network rocketmq apache/rocketmq:5.3.1 sh mqnamesrv
          echo 'Complete create NameServer'
          
          sleep 5
          
          echo 'Start viewing NameServer logs'
          docker logs rmqnamesrv
          echo 'Complete viewing NameServer logs'
          
          # Create broker config
          echo "brokerIP1=127.0.0.1" > broker.conf
          chmod 777 broker.conf
          
          # Start Broker and Proxy
          # -p 8080:8080 -p 8081:8081
          echo 'Start create Broker'
          docker run -d \
          --name rmqbroker \
          --network rocketmq \
          -p 10912:10912 -p 10911:10911 -p 10909:10909 \
          -e "NAMESRV_ADDR=rmqnamesrv:9876" \
          -v ./broker.conf:/home/rocketmq/rocketmq-4.9.4/conf/broker.conf \
          apache/rocketmq:5.3.1 sh mqbroker --enable-proxy \
          -c /home/rocketmq/rocketmq-4.9.4/conf/broker.conf
          echo 'Complete create Broker'
          
          sleep 5
          
          echo 'Start viewing Broker logs'
          docker logs rmqbroker
          echo 'Complete viewing Broker logs'

          sleep 10
          
          # Create Topic
          echo 'Start Create Topic'
          docker exec rmqbroker sh mqadmin updateTopic -n rmqnamesrv:9876 -c DefaultCluster -t user-rocketmq-broadcast
          echo 'Complete Create Topic'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to be fully ready..."
          # 等待 MySQL 服务完全启动
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot --silent 2>/dev/null; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... attempt $i"
            sleep 2
          done
          # 额外等待以确保完全稳定
          sleep 5

      - name: Initialize MySQL database
        run: |
          echo "Initializing MySQL database with schema.sql"
          # 检查 schema.sql 文件是否存在
          if [ -f "${{ env.NACOS_BOOTSTRAP_DIR }}/src/main/resources/sql/mysql-schema.sql" ]; then
            echo "Found schema.sql file"
            # 使用 --show-warnings 参数来抑制警告
            mysql -h 127.0.0.1 -P 3306 -u root -proot --show-warnings --connect-timeout=30 ${{ env.MYSQL_DATABASE }} < ${{ env.NACOS_BOOTSTRAP_DIR }}/src/main/resources/sql/mysql-schema.sql
            mysql -h 127.0.0.1 -P 3306 -u root -proot --show-warnings --connect-timeout=30 ${{ env.MYSQL_DATABASE }} < ${{ env.NACOS_BOOTSTRAP_DIR }}/src/main/resources/sql/mysql-data.sql
            echo "Database initialized successfully"
          else
            echo "ERROR: schema.sql file not found at ${{ env.NACOS_BOOTSTRAP_DIR }}/src/main/resources/sql/mysql-schema.sql"
            exit 1
          fi

      - name: cat ~/.m2/settings.xml
        run: |
          cat ~/.m2/settings.xml

      - name: Build with Maven
        run: ./mvnw clean install -U -DskipTests

      - name: Start nacos-bootstrap
        run: |
          cd ${{ env.NACOS_BOOTSTRAP_DIR }}
          nohup ./mvnw spring-boot:run &
          sleep 30

      - name: Start ${{ env.MODULE_NAME }} services
        run: |
          cd ${{ env.MODULE_NAME }}
          nohup ./mvnw spring-boot:run -pl user &
          sleep 20
          nohup ./mvnw spring-boot:run -pl gateway &
          sleep 20

      - name: Run ${{ env.MODULE_NAME }} tests
        run: |
          cd ${{ env.MODULE_NAME }}
          ./mvnw test

      - name: Clean Maven snapshots
        run: |
          echo "Cleaning Maven snapshots..."
          # GitHub Actions 中 Maven 仓库默认位置是 ~/.m2/repository
          find ~/.m2/repository -type d -name '*-SNAPSHOT' -print -exec rm -r {} +
